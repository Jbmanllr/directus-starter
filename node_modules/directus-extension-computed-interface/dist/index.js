import{useStores as e,useApi as t,useCollection as n,defineInterface as r}from"@directus/extensions-sdk";import{ref as i,computed as l,watch as u,defineComponent as o,toRefs as a,inject as f,resolveComponent as s,openBlock as d,createElementBlock as c,Fragment as p,normalizeStyle as m,createElementVNode as g,toDisplayString as v,createBlock as y,mergeProps as S,withCtx as h,createTextVNode as E,createCommentVNode as T}from"vue";function N(e,t){return(e.match(/{{.*?}}/g)||[]).some((e=>e.includes(t)))}const A=(n,r,o,a,f,s)=>{const d=t(),c=e().useUserStore(),p=i({__currentUser:c.currentUser});let m={},g={};const v=l((()=>JSON.stringify(n.value,((e,t)=>void 0===t?null:t))));return u(v,(async(e,t)=>{var n,i,l;const u=JSON.parse(e),v=void 0!==t?JSON.parse(t):{};if(!function(e,t,n,r){const i=[];for(const e of Object.keys({...r,...n}))e!==t&&n[e]!==r[e]&&JSON.stringify(n[e])!==JSON.stringify(r[e])&&i.push(e);return!i.length||i.some((t=>N(e,t)))}(s,a.value,u,v))return;for(const e of Object.keys(v))e in u||(u[e]=null);let y={};const S=u.id||f.value;for(const e of Object.keys(u)){const t=r.value.find((t=>{var n,r;return[null===(n=t.meta)||void 0===n?void 0:n.one_field,null===(r=t.meta)||void 0===r?void 0:r.many_field].includes(e)}));if(!t||!N(s,e))continue;const a=t.collection===o.value;let f=null!==(l=u[a?null===(n=t.meta)||void 0===n?void 0:n.many_field:null===(i=t.meta)||void 0===i?void 0:i.one_field])&&void 0!==l?l:{create:[],update:[],delete:[]},c=[],p=[];if(a)"number"==typeof f||"string"==typeof f?(f={update:[{id:f}]},"object"==typeof v[e]&&(m={},g={})):"object"==typeof f&&(f="id"in f?{update:[f]}:{create:[{...f}]});else{if(f instanceof Array&&!(v[e]instanceof Array)&&(m={},g={}),"+"!==S){let t;e in m?t=m[e]:(t=(await d.get(`items/${o.value}/${S}`,{params:{fields:[e]}})).data.data[e],m[e]=t),c=c.concat(t)}if(f.update){const e=f.update.map((({id:e})=>e));c=c.filter((t=>!e.includes(t)))}f.delete&&(c=c.filter((e=>!f.delete.includes(e))))}if(f.update&&(c=c.concat(f.update.map((({id:e})=>e)))),c.length){const e=a?t.related_collection:t.collection,n="directus_users"===e?"/users":`items/${e}`;if(e){let t;t=e in g&&c.every((t=>t in g[e]))?c.map((t=>g[e][t])):(await d.get(n,{params:{filter:{id:{_in:c.join(",")}}}})).data.data,p=t.map((t=>{var n;return e in g?g[e][t.id]=t:g[e]={[t.id]:t},{...t,...null===(n=f.update)||void 0===n?void 0:n.find((({id:e})=>t.id===e))}}))}}f.create&&(p=p.concat(f.create)),y[e]=a?p[0]:p}p.value={...u,...y,__currentUser:c.currentUser}}),{deep:!1,immediate:!0}),p},M=(e,t)=>{let n=e;for(const e of t.split(".")){if(!(e in n))return{value:null,found:!1};n=n[e]}return{value:n,found:!0}};function R(e,t,n={},r=!1){const i=function(e,t,n={},r=!1){var i,l,u,o,a,f,s,d,c,p,m,g,v,y,S,h;if(t){if((e=e.trim()).startsWith('"')&&e.endsWith('"'))return e.slice(1,-1).replace(/\\"/g,'"');let{value:E,found:T}=M(t,e);if(!T||null===E){let t=M(n,e);if(t.found)return t.value}if(T)return E;if("$NOW"===e)return new Date;if(e.startsWith("$CURRENT_USER"))return"$CURRENT_USER"===e?null===(i=t.__currentUser)||void 0===i?void 0:i.id:M({$CURRENT_USER:t.__currentUser},e).value;const N=function(e){const t=e.trim().match(/^([A-Z_]+)\((.+)\)$/);if(t){const e=[],n=t[1],r=t[2];let i=0,l=0,u=0,o=!1,a=!1;for(;l<r.length;l+=1){const t=r[l];if("("!==t||o)if(")"!==t||o)if(","!==t||o||0!==i)if('"'!==t||a){if("\\"===t&&o){a=!0;continue}}else o=!o;else e.push(r.slice(u,l).trim()),u=l+1;else i-=1;else i+=1;a=!1}return u<l&&e.push(r.slice(u,l).trim()),{op:n,args:e}}return null}(e);if(N){const{op:e,args:i}=N;if(1===i.length){const l=R(i[0],t,n,r);if("INT"===e)return parseInt(l);if("FLOAT"===e)return parseFloat(l);if("STRING"===e)return String(l);if("DATE"===e)return new Date(l);if("SLUG"===e)return function(e){if("string"!=typeof e)return"";let t=e.replace(/^\s+|\s+$/g,"");t=t.toLowerCase();const n="àáãảạăằắẳẵặâầấẩẫậèéẻẽẹêềếểễệđùúủũụưừứửữựòóỏõọôồốổỗộơờớởỡợìíỉĩịäëïîöüûñçýỳỹỵỷ",r="aaaaaaaaaaaaaaaaaeeeeeeeeeeeduuuuuuuuuuuoooooooooooooooooiiiiiaeiiouuncyyyyy";for(let e=0,i=n.length;e<i;e++)t=t.replace(new RegExp(n.charAt(e),"g"),r.charAt(e));return t=t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-"),t}(l);if("CURRENCY"===e)return(new Intl.NumberFormat).format(l);if("DATE_ISO"===e)return new Date(l).toISOString();if("DATE_UTC"===e)return new Date(l).toUTCString();if("DATE_STR"===e){const e=new Date(l);return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}if("TIME_STR"===e){const e=new Date(l);return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}`}if(["YEAR","MONTH","GET_DATE","DAY","HOURS","MINUTES","SECONDS","TIME"].includes(e)){if(l instanceof Date){return l[{YEAR:"getFullYear",MONTH:"getMonth",GET_DATE:"getDate",DAY:"getDay",HOURS:"getHours",MINUTES:"getMinutes",SECONDS:"getSeconds",TIME:"getTime"}[e]]()}return 0}if("ABS"===e)return Math.abs(l);if("SQRT"===e)return Math.sqrt(l);if("SUM"===e)return l instanceof Array?l.reduce(((e,t)=>e+t),0):0;if("AVERAGE"===e)return l instanceof Array?l.reduce(((e,t)=>e+t),0)/l.length:0;if("CEIL"===e)return Math.ceil(l);if("FLOOR"===e)return Math.floor(l);if("ROUND"===e)return Math.round(l);if("EXP"===e)return Math.exp(l);if("LOG"===e)return Math.log(l);if("MAX"===e)return l instanceof Array?Math.max(...l):0;if("MIN"===e)return l instanceof Array?Math.min(...l):0;if("NULL"===e)return null===l;if("NOT_NULL"===e)return null!==l;if("NOT"===e)return!l;if("STR_LEN"===e)return String(l).length;if("LOWER"===e)return String(l).toLowerCase();if("UPPER"===e)return String(l).toUpperCase();if("TRIM"===e)return String(l).trim();if("ENCODE_URL_COMPONENT"===e)return encodeURIComponent(l);if("ARRAY_LEN"===e)return l instanceof Array?l.length:0}else if(2===i.length){if("ASUM"===e)return null!==(u=null===(l=t[i[0]])||void 0===l?void 0:l.reduce(((e,t)=>e+R(i[1],t,{},r)),0))&&void 0!==u?u:0;if("AMIN"===e)return null!==(a=null===(o=t[i[0]])||void 0===o?void 0:o.reduce(((e,t)=>Math.min(e,R(i[1],t,{},r))),1/0))&&void 0!==a?a:0;if("AMAX"===e)return null!==(s=null===(f=t[i[0]])||void 0===f?void 0:f.reduce(((e,t)=>Math.max(e,R(i[1],t,{},r))),-1/0))&&void 0!==s?s:0;if("AAVG"===e){const e=null!==(d=t[i[0]])&&void 0!==d?d:[];return e.reduce(((e,t)=>e+R(i[1],t,{},r)),0)/e.length}if("AMUL"===e)return null!==(p=null===(c=t[i[0]])||void 0===c?void 0:c.reduce(((e,t)=>e*R(i[1],t,{},r)),1))&&void 0!==p?p:0;if("AAND"===e)return null!==(g=null===(m=t[i[0]])||void 0===m?void 0:m.reduce(((e,t)=>e&&R(i[1],t,{},r)),!0))&&void 0!==g&&g;if("AOR"===e)return null!==(y=null===(v=t[i[0]])||void 0===v?void 0:v.reduce(((e,t)=>e||R(i[1],t,{},r)),!1))&&void 0!==y&&y;if("ACOUNT"===e)return null!==(h=null===(S=t[i[0]])||void 0===S?void 0:S.reduce(((e,t)=>e+(R(i[1],t,{},r)?1:0)),0))&&void 0!==h?h:0;const E=R(i[0],t,n,r),T=R(i[1],t,n,r);if("SUM"===e)return E+T;if("SUBTRACT"===e)return E-T;if("MULTIPLY"===e)return E*T;if("DIVIDE"===e)return E/T;if("REMAINDER"===e)return E%T;if("ROUND"===e)return E.toFixed(T);if("MAX"===e)return Math.max(E,T);if("MIN"===e)return Math.min(E,T);if("POWER"===e)return Math.pow(E,T);if("CONCAT"===e)return String(E)+String(T);if("LEFT"===e)return String(E).slice(0,Number(T));if("RIGHT"===e)return String(E).slice(-Number(T));if("REPT"===e)return String(E).repeat(Number(T));if("JOIN"===e)return E instanceof Array?E.join(String(T)):"";if("SPLIT"===e)return String(E).split(String(T));if("SEARCH"===e){const e=String(E),t=String(T);return e.indexOf(t)}if("EQUAL"===e)return E===T;if("NOT_EQUAL"===e)return E!==T;if("GT"===e)return E>T;if("GTE"===e)return E>=T;if("LT"===e)return E<T;if("LTE"===e)return E<=T;if("AND"===e)return E&&T;if("OR"===e)return E||T}else if(3===i.length){if("IF"===e)return!0===R(i[0],t,n,r)?R(i[1],t,n,r):R(i[2],t,n,r);if("MID"===e){const e=String(R(i[0],t,n,r)),l=Number(R(i[1],t,n,r)),u=Number(R(i[2],t,n,r));return e.slice(l,l+u)}if("SUBSTITUTE"===e){const e=String(R(i[0],t,n,r)),l=String(R(i[1],t,n,r)),u=String(R(i[2],t,n,r));return e.split(l).join(u)}if("SEARCH"===e){const e=String(R(i[0],t,n,r)),l=String(R(i[1],t,n,r)),u=Number(R(i[2],t,n,r));return e.indexOf(l,u)}}else if(i.length%2==0&&"IFS"===e){for(let e=0;e<i.length;e+=2)if(!0===R(i[e],t,n,r))return R(i[e+1],t,n,r);return null}}if(!isNaN(parseFloat(e)))return parseFloat(e);if(r)throw new Error(`Cannot parse expression: ${e}`)}return""}(e,t,n,r);return r&&console.log(`${e} =`,i),i}var U=o({props:{value:{type:[String,Number],default:null},field:{type:String,default:null},type:{type:String,default:null},collection:{type:String,default:""},primaryKey:{type:[String,Number],default:""},template:{type:String,default:""},mode:{type:String,default:null},prefix:{type:String,default:null},suffix:{type:String,default:null},customCss:{type:Object,default:null},debugMode:{type:Boolean,default:!1},computeIfEmpty:{type:Boolean,default:!1},initialCompute:{type:Boolean,default:!1}},emits:["input"],setup(t,{emit:r}){const l=n(t.collection).defaults,o=i(t.value),s=(t=>{const{useRelationsStore:n}=e(),{getRelationsForCollection:r}=n();return i(r(t))})(t.collection),{collection:d,field:c,primaryKey:p}=a(t),m=A(f("values"),s,d,c,p,t.template),g=i(null);return m&&u(m,(()=>{const e=function(){var e;try{const e=t.template.replace(/{{.*?}}/g,(e=>R(e.slice(2,-2).trim(),m.value,l.value,t.debugMode)));return g.value=null,["integer","decimal","bigInteger"].includes(t.type)?parseInt(e)||0:["float"].includes(t.type)?parseFloat(e)||0:e}catch(t){return g.value=null!==(e=t.message)&&void 0!==e?e:"Unknown error",null}}();o.value=e,"displayonly"!==t.mode&&e!==t.value&&setTimeout((()=>{r("input",e)}),1)}),{immediate:t.initialCompute||t.computeIfEmpty&&(null===t.value||void 0===t.value)}),{computedValue:o,errorMsg:g}}});const O={class:"prefix"},I={class:"computed-value"},C={class:"suffix"};U.render=function(e,t,n,r,i,l){const u=s("v-input"),o=s("v-notice");return d(),c(p,null,[e.mode?(d(),c("div",{key:0,style:m(e.customCss)},[g("span",O,v(e.prefix),1),g("span",I,v(e.computedValue),1),g("span",C,v(e.suffix),1)],4)):(d(),y(u,S({key:1},e.$attrs,{field:e.field,collection:e.collection,"primary-key":e.primaryKey,"model-value":e.value,"onUpdate:modelValue":t[0]||(t[0]=t=>e.$emit("input",t))}),null,16,["field","collection","primary-key","model-value"])),e.errorMsg?(d(),y(o,{key:2,type:"danger"},{default:h((()=>[E(v(e.errorMsg),1)])),_:1})):T("v-if",!0)],64)},U.__file="src/interface.vue";var b=r({id:"computed",name:"Computed",icon:"calculate",description:"Perform computed value based on other fields",component:U,types:["string","text","integer","decimal","bigInteger","float","boolean","alias"],group:"other",options:[{field:"template",name:"Template",type:"string",meta:{width:"full",interface:"input"}},{field:"mode",name:"Field Mode",type:"string",meta:{width:"full",interface:"select-dropdown",options:{allowNone:!0,choices:[{text:"Display Only",value:"displayonly"},{text:"Read Only",value:"readonly"}]}}},{field:"prefix",name:"Prefix",type:"string",meta:{width:"half",interface:"system-input-translated-string",options:{trim:!1}}},{field:"suffix",name:"Suffix",type:"string",meta:{width:"half",interface:"system-input-translated-string",options:{trim:!1}}},{field:"customCss",name:"Custom CSS",type:"json",meta:{width:"full",interface:"input-code",options:{language:"json"}}},{field:"debugMode",name:"Debug Mode",type:"boolean",meta:{width:"full",interface:"boolean",note:"Used for debugging the template. It will show an error message if the template is invalid. It will also log to console the result of each component of the template."}},{field:"computeIfEmpty",name:"Compute If Empty",type:"boolean",meta:{width:"full",interface:"boolean",note:"Compute the value if the field is empty. This is useful if you want a value to be computed once such as the created date or a unique ID."}},{field:"initialCompute",name:"Initial Compute",type:"boolean",meta:{width:"full",interface:"boolean",note:"Compute the value when opening the form. This is useful if you want to compute a value based on the current date or other dynamic values."}}]});export{b as default};
